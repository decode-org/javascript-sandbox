<!DOCTYPE html>
<html>
  <head>
  </head>
</html>
<body>
  <div id="output" style="position: absolute; width: 100%; height: 100%;"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bonsai/0.4.5/bonsai.min.js"></script>
  <script>
    var renderer;
    var errorElement;

    function addError() {
      errorElement = document.createElement('div');
      errorElement.className = 'error-message';
      document.body.insertBefore(errorElement, document.body.firstChild);
    };

    window.addEventListener('message', function(m) {
      var overrides = function() {
        var overridePoints = [
          {
            object: Text,
            props: ['text', 'fontSize', 'fontFamily', 'fontStyle', 'fontWeight', 'glyphx', 'glyphy', 'cap', 'fill', 'join', 'line', 'textStrokeWidth', 'miterLimit', 'selectable']
          },
          {
            object: TextSpan,
            props: ['text', 'fontSize', 'fontFamily', 'fontStyle', 'fontWeight', 'glyphx', 'glyphy', 'cap', 'fill', 'join', 'line', 'textStrokeWidth', 'miterLimit', 'selectable']
          },
          {
            object: Rect
          },
          {
            object: Circle
          },
          {
            object: Ellipse
          },
          {
            object: Group
          },
          {
            object: Polygon
          },
          {
            object: Star
          },
          {
            object: SpecialAttrPath
          },
          {
            object: Path
          }
        ];
        var defaultOverrides = ['matrix', 'opacity', 'rotation', 'origin', 'scale', 'scaleX', 'scaleY', 'x', 'y', 'filters'];
        var overrideProperty = function(ob, name) {
          Object.defineProperty(ob.prototype, name, {
            get: function() {
              return this.attr(name);
            },
            set: function(val) {
              return this.attr(name, val);
            }
          });

        };

        overridePoints.forEach(function(point) {
          defaultOverrides.forEach(function(name) {
            overrideProperty(point.object, name);
          });
        });

        this.onerror = function(e) {
          stage.sendMessage('error', { });
        };
      };

      try {
        var code = new Function('(' + overrides.toString() + ')(); ' + m.data);
        if (errorElement) {
          document.body.removeChild(errorElement);
          errorElement = null;
        }
      } catch (e) {
        // Don't log this
        if (!errorElement) {
          addError();
        }
      }

      if (renderer) {
        renderer.destroy();
      }
      renderer = bonsai.run(document.getElementById('output'), {
        code: code
      });

      renderer.on('load', function(e) {
        renderer.on('message:error', function(data) {
          if (!errorElement) {
            addError();
          }
        });
      });
    });
  </script>
</body>
